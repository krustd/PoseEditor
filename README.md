# 姿态标注修正工具 v2.0

这是一个用于人体姿态关键点标注和修正的图形化工具，支持17个人体关键点的编辑、可见性设置、美学评分和语音输入功能。

## 功能概述

- **关键点编辑**：支持17个人体关键点的拖拽修正
- **可见性设置**：支持三种可见性状态（可见、遮挡、不可见）
- **美学评分**：0-10分的姿态美学评分系统
- **语音输入**：支持语音转文字功能，用于图像描述输入
- **批量处理**：支持文件夹批量加载和切换
- **撤销/重做**：完整的操作历史管理
- **智能缩放**：自动聚焦姿态区域或适应窗口

## 安装与运行

1. **确保已安装Python 3.9或更高版本**
2. **必须安装FFmpeg**（语音识别功能的必要依赖）：
   - Windows: 下载FFmpeg并添加到系统PATH环境变量
   - macOS: `brew install ffmpeg`
   - Linux (Ubuntu/Debian): `sudo apt-get install ffmpeg`
   - 验证安装: 在命令行运行 `ffmpeg -version`
3. 安装Python依赖：`pip install -r requirements.txt` 或 `uv sync`（如果使用uv）
4. 运行程序：`python main.py`

### 依赖项

- PySide6：图形界面框架
- OpenAI Whisper：语音识别模型（需要系统安装FFmpeg）
- PyAudio：音频录制（可能需要系统级依赖）
- NumPy：数值计算

### PyAudio 跨平台安装指南

PyAudio 在不同平台上可能需要额外的系统级依赖：

#### Windows
- 通常可以直接安装：`pip install pyaudio`
- 如果失败，尝试使用预编译的wheel包：`pip pip install pipwin` 然后 `pipwin install pyaudio`

#### macOS
- 使用Homebrew安装PortAudio：`brew install portaudio`
- 然后安装PyAudio：`pip install pyaudio`

#### Linux (Ubuntu/Debian)
- 安装PortAudio开发库：`sudo apt-get install portaudio19-dev python3-pyaudio`
- 或使用pip安装：`pip install pyaudio`

#### Linux (CentOS/RHEL/Fedora)
- 安装必要的开发包：`sudo yum install portaudio-devel` 或 `sudo dnf install portaudio-devel`
- 然后安装PyAudio：`pip install pyaudio`

如果安装过程中遇到错误，请确保系统已安装C编译器和Python开发包。

## 界面布局

工具采用"左图右控"的布局设计：

- **左侧主画布**：显示图片和姿态关键点
- **右侧控制面板**：包含文件操作、评分、关键点列表和视图控制

## 操作指南

### 基本操作

#### 关键点编辑
- **选择关键点**：鼠标左键点击关键点
- **拖拽移动**：按住左键拖动关键点到新位置
- **瞬移功能**：按住Ctrl键点击目标位置，关键点将直接移动到该位置

#### 可见性设置
- **可见 (v=2)**：关键点在画面内且清晰可见（绿色显示）
- **遮挡 (v=1)**：关键点被遮挡但位置可猜测（橙色显示）
- **不可见 (v=0)**：关键点在画面外或不存在（红色显示）

快捷键：
- **A键**：标记为遮挡
- **D键**：标记为不可见
- **S键**：标记为可见

#### 视图控制
- **滚轮**：缩放图片（以鼠标位置为中心）
- **右键拖拽**：平移画布
- **适应窗口**：点击"适应窗口"按钮重置视图

### 文件操作

#### 加载图片
1. 点击"打开图片文件夹"按钮
2. 选择包含图片的文件夹
3. 工具将自动加载文件夹中的所有图片（支持.jpg, .jpeg, .png, .bmp, .tiff格式）

#### 图片导航
- **上一张**：点击"上一张"按钮或按左方向键
- **下一张**：点击"下一张"按钮或按右方向键
- **自动保存**：切换图片时自动保存当前标注

#### 废弃处理
- **标记为废弃**：点击"标记为废弃/移动到Ignore"按钮或按Delete键
- **自动移动**：图片和对应的JSON文件将自动移动到ignore文件夹

### 美学评分

工具提供0-10分的姿态美学评分系统：

- **评分按钮**：点击0-10的数字按钮进行评分
- **N/A按钮**：表示未评分状态
- **自动保存**：评分会随标注数据一起保存

### 语音输入功能

工具集成了语音转文字功能，支持中文语音输入：

- **背景描述**：描述图片中的背景环境
- **人物描述**：描述图片中人物的状态和动作

#### 使用方法

1. **开始录音**：点击"按住说话"按钮或按住按钮不放
2. **停止录音**：再次点击按钮或松开鼠标
3. **自动转写**：录音完成后，系统会自动调用Whisper模型进行语音识别
4. **文本编辑**：识别结果会自动填入文本框，可以进行手动修改

#### 注意事项

- 首次使用时，系统会自动下载Whisper语音识别模型
- 语音识别需要网络连接（仅首次下载）
- 支持中文语音识别
- 可以多次录音，文本会自动追加到现有内容后

### 高级功能

#### 撤销/重做
- **撤销**：Ctrl+Z或菜单栏"编辑"→"撤销"
- **重做**：Ctrl+Y或菜单栏"编辑"→"重做"

#### 关键点切换
- **Tab键**：按顺序切换到下一个关键点
- **Shift+Tab**：按顺序切换到上一个关键点
- **列表选择**：在右侧关键点列表中点击选择

#### 骨架显示
- **显示/隐藏**：点击"隐藏骨架"按钮或按H键切换骨架连线显示

## 数据格式

工具使用JSON格式存储姿态数据，每个图片对应一个同名的JSON文件：

```json
{
  "score": 7,
  "background_desc": "街道，天气晴朗，有建筑物",
  "character_desc": "穿着红色外套，正在跑步",
  "keypoints": [
    {
      "name": "nose",
      "x": 245.5,
      "y": 180.3,
      "visibility": 2
    },
    // ... 其他16个关键点
  ]
}
```

### 字段说明

- `score`：姿态美学评分（-1表示未评分，0-10表示评分）
- `background_desc`：背景描述文本
- `character_desc`：人物描述文本
- `keypoints`：17个人体关键点数组

### 关键点定义

工具支持17个人体关键点：

1. nose（鼻子）
2. left_eye（左眼）
3. right_eye（右眼）
4. left_ear（左耳）
5. right_ear（右耳）
6. left_shoulder（左肩）
7. right_shoulder（右肩）
8. left_elbow（左肘）
9. right_elbow（右肘）
10. left_wrist（左腕）
11. right_wrist（右腕）
12. left_hip（左髋）
13. right_hip（右髋）
14. left_knee（左膝）
15. right_knee（右膝）
16. left_ankle（左踝）
17. right_ankle（右踝）

### 骨架连接

骨架按以下方式连接：
- 头部：(0,1), (0,2), (1,3), (2,4)
- 躯干：(5,6), (5,11), (6,12), (11,12)
- 左臂：(5,7), (7,9)
- 右臂：(6,8), (8,10)
- 左腿：(11,13), (13,15)
- 右腿：(12,14), (14,15)

## 快捷键参考

| 功能 | 快捷键 |
|------|--------|
| 上一张图片 | ← |
| 下一张图片 | → |
| 保存 | Ctrl+S |
| 撤销 | Ctrl+Z |
| 重做 | Ctrl+Y |
| 切换关键点 | Tab/Shift+Tab |
| 标记为遮挡 | A |
| 标记为不可见 | D |
| 标记为可见 | S |
| 移动到Ignore | Delete |
| 显示/隐藏骨架 | H |
| 打开文件夹 | Ctrl+O |

## 工作流程建议

1. **准备数据**：将需要标注的图片放在同一文件夹中
2. **批量加载**：使用"打开图片文件夹"功能加载所有图片
3. **标注修正**：
   - 对于已有标注的图片，工具会自动聚焦到姿态区域
   - 对于新图片，工具会显示全图，便于从零开始标注
4. **添加描述**：使用语音输入或文本输入为图片添加背景和人物描述
5. **评分**：根据姿态质量进行美学评分
6. **质量筛选**：将质量差的图片标记为废弃，移动到ignore文件夹
7. **批量处理**：使用快捷键快速切换图片，提高工作效率

## 注意事项

- 工具会自动保存修改，切换图片时无需手动保存
- 使用ignore功能可以有效地筛选数据质量
- 评分功能可用于后续的数据质量分析和模型训练
- 语音输入功能需要麦克风权限，首次使用时会自动下载Whisper模型
- 支持高分辨率图片的流畅缩放和编辑
- 描述文本会随标注数据一起保存，可用于后续的文本-图像模型训练

## 技术支持

如有问题或建议，请联系开发人员(krust@foxmail.com)。
